DROP TABLE DETALLE_FACTURA CASCADE CONSTRAINTS;
DROP TABLE CLIENT CASCADE CONSTRAINTS;
DROP TABLE FACTURA CASCADE CONSTRAINTS;
DROP TABLE MERCHAN CASCADE CONSTRAINTS;

ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/YYYY';

CREATE TABLE CLIENT(
CIF VARCHAR2(9) PRIMARY KEY,
EMPRESA VARCHAR2(50),
DIRECCIÓN VARCHAR2(50),
MAIL VARCHAR2(50) CHECK (MAIL LIKE '%@%')
);

CREATE TABLE MERCHAN(
PRODUCTO NUMBER(4) PRIMARY KEY,
DESCRIPCION VARCHAR2(50),
MATERIAL VARCHAR2(50),
PRECIO NUMBER(10,2)
);

CREATE TABLE FACTURA(
NUM_FACT NUMBER(10) PRIMARY KEY,
CIF_CLIENTE VARCHAR2(9) NOT NULL REFERENCES CLIENT,
FECHA DATE,
IVA NUMBER(2) NOT NULL 
);

CREATE TABLE DETALLE_FACTURA(
NUM_FACT NUMBER(10) REFERENCES FACTURA ON DELETE CASCADE,
PRODUCTO NUMBER(4) REFERENCES MERCHAN,
CANTIDAD NUMBER(3) DEFAULT 1,
PRIMARY KEY (NUM_FACT,PRODUCTO)
);

INSERT INTO CLIENT VALUES('12300000A','BOT SA','Avda Resina, Laredo, cp 39770, Cantabria','info@bot.es');
INSERT INTO CLIENT VALUES('98700000B','Pantaleón','Calle Sin, Madrid, cp 28001, Madrid','recepcion@pantaleon.es');
INSERT INTO CLIENT VALUES('25200000C','Games+','Calle Discrección, Madrid, cp 28008, Madrid','hola@gamesmas.com');
INSERT INTO MERCHAN VALUES(60,'Cenicero con escudo', 'metal',5.6);
INSERT INTO MERCHAN VALUES(70,'Llavero personalizado','resina',8);
INSERT INTO MERCHAN VALUES(80,'Cojín impreso','tela',12.9);
INSERT INTO MERCHAN VALUES(90,'Puzzle foto', 'cartón',15.25);
INSERT INTO MERCHAN VALUES(100,'Imán nevera', 'metal',2);
INSERT INTO FACTURA VALUES(1,'12300000A', '30/12/21',21);
INSERT INTO FACTURA VALUES(2,'12300000A', '30/12/21',21);
INSERT INTO FACTURA VALUES(3,'98700000B', '29/12/21',21);
INSERT INTO DETALLE_FACTURA VALUES(1,60,5);
INSERT INTO DETALLE_FACTURA VALUES(1,70,8);
INSERT INTO DETALLE_FACTURA VALUES(1,80,2);
INSERT INTO DETALLE_FACTURA VALUES(2,60,15);
INSERT INTO DETALLE_FACTURA(NUM_FACT,PRODUCTO) VALUES(3,80);

COMMIT;

SELECT * FROM CLIENT;
SELECT * FROM MERCHAN;
SELECT * FROM FACTURA;
SELECT * FROM DETALLE_FACTURA;

/* a) Muestra los siguientes datos de todas las facturas: número de factura, 
      fcha, CIF del cliente, nombre del cliente y dirección del cliente. */

SELECT NUM_FACT, FECHA, CIF, EMPRESA, DIRECCIÓN
FROM CLIENT C, FACTURA F
WHERE C.CIF = F.CIF_CLIENTE;

SELECT NUM_FACT, FECHA, CIF, EMPRESA, DIRECCIÓN
FROM CLIENT C
INNER JOIN FACTURA F ON C.CIF = F.CIF_CLIENTE;

/* b) Muestra un listado con: número de factura, fecha, producto dentro de la 
      factura y cantidad. */

SELECT F.NUM_FACT, FECHA, PRODUCTO, CANTIDAD
FROM FACTURA F, DETALLE_FACTURA DF
WHERE F.NUM_FACT = DF.NUM_FACT;

SELECT F.NUM_FACT, FECHA, PRODUCTO, CANTIDAD
FROM FACTURA F
INNER JOIN DETALLE_FACTURA DF ON F.NUM_FACT = DF.NUM_FACT;

/* c) Muestra un listado con: número de factura, fecha, producto dentro de la 
      factura, descripción del producto y cantidad. Ordena el listado por 
      número de factura. */

SELECT F.NUM_FACT, FECHA, M.PRODUCTO, DESCRIPCION, CANTIDAD
FROM FACTURA F, DETALLE_FACTURA DF, MERCHAN M
WHERE F.NUM_FACT = DF.NUM_FACT AND M.PRODUCTO = DF.PRODUCTO
ORDER BY NUM_FACT ASC;

SELECT F.NUM_FACT, FECHA, M.PRODUCTO, DESCRIPCION, CANTIDAD
FROM FACTURA F
INNER JOIN DETALLE_FACTURA DF ON F.NUM_FACT = DF.NUM_FACT
INNER JOIN MERCHAN M ON M.PRODUCTO = DF.PRODUCTO
ORDER BY NUM_FACT ASC;

/* d) Muestra un listado con: CIF de cliente y factura. Deben aparecer todos 
      los clientes (aunque no tengan facturas). */

SELECT CIF, NUM_FACT
FROM CLIENT C, FACTURA F
WHERE C.CIF = F.CIF_CLIENTE(+);

SELECT CIF, NUM_FACT
FROM CLIENT C
LEFT JOIN FACTURA F ON C.CIF = F.CIF_CLIENTE;

/* e) Muestra los materiales de los productos que ha comprado el cliente 
      'BOT SA'. */
      
SELECT DISTINCT MATERIAL 
FROM MERCHAN M, DETALLE_FACTURA DF, FACTURA F
WHERE M.PRODUCTO = DF.PRODUCTO AND F.NUM_FACT = DF.NUM_FACT
    AND F.CIF_CLIENTE = (SELECT CIF 
                         FROM CLIENT
                         WHERE EMPRESA = 'BOT SA');

SELECT DISTINCT MATERIAL
FROM MERCHAN M
INNER JOIN DETALLE_FACTURA DF ON M.PRODUCTO = DF.PRODUCTO
INNER JOIN FACTURA F ON F.NUM_FACT = DF.NUM_FACT
WHERE F.CIF_CLIENTE = (SELECT CIF FROM CLIENT
                       WHERE EMPRESA = 'BOT SA');

SELECT DISTINCT MATERIAL
FROM MERCHAN M, DETALLE_FACTURA DF, FACTURA F, CLIENT C
WHERE F.NUM_FACT = DF.NUM_FACT AND M.PRODUCTO = DF.PRODUCTO AND C.CIF = F.CIF_CLIENTE
    AND C.EMPRESA = 'BOT SA';

SELECT DISTINCT MATERIAL
FROM MERCHAN M
INNER JOIN DETALLE_FACTURA DF ON M.PRODUCTO = DF.PRODUCTO
INNER JOIN FACTURA F ON F.NUM_FACT = DF.NUM_FACT
INNER JOIN CLIENT C ON C.CIF = F.CIF_CLIENTE
WHERE C.EMPRESA = 'BOT SA';

/* f) Muestra un listado con: producto, descripción de producto, material, 
      número de factura. Deben aparecer todos los productos (aunque no están 
      en facturas) */

SELECT M.PRODUCTO, DESCRIPCION, MATERIAL, NUM_FACT
FROM MERCHAN M, DETALLE_FACTURA DF
WHERE M.PRODUCTO = DF.PRODUCTO(+);

SELECT M.PRODUCTO, DESCRIPCION, MATERIAL, NUM_FACT
FROM MERCHAN M
LEFT JOIN DETALLE_FACTURA DF ON M.PRODUCTO = DF.PRODUCTO;

/* g) AMPLIACIÓN: Calcula el importe total de la factura de número 1 
      (antes de impuestos). */
SELECT SUM(PRECIO * CANTIDAD) "IMPORTE_SIN_IVA" 
FROM MERCHAN M, DETALLE_FACTURA DF
WHERE M.PRODUCTO = DF.PRODUCTO
    AND NUM_FACT = 1;
    
SELECT SUM(PRECIO * CANTIDAD) "IMPORTE_SIN_IVA"
FROM MERCHAN M
INNER JOIN DETALLE_FACTURA DF ON M.PRODUCTO = DF.PRODUCTO
WHERE NUM_FACT = 1;
